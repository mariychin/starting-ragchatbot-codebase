<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG System Query Flow Diagram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .flow-diagram {
            min-width: 1200px;
            height: 800px;
            position: relative;
            background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                        linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                        linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .component {
            position: absolute;
            border: 2px solid;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-align: center;
            font-weight: bold;
            min-width: 120px;
        }

        .frontend { border-color: #4CAF50; background-color: #E8F5E8; }
        .api { border-color: #2196F3; background-color: #E3F2FD; }
        .rag { border-color: #FF9800; background-color: #FFF3E0; }
        .ai { border-color: #9C27B0; background-color: #F3E5F5; }
        .tools { border-color: #F44336; background-color: #FFEBEE; }
        .data { border-color: #607D8B; background-color: #ECEFF1; }

        .arrow {
            position: absolute;
            stroke: #333;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .flow-label {
            position: absolute;
            background: #fff;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        .user-icon {
            position: absolute;
            top: 20px;
            left: 50px;
            width: 60px;
            height: 60px;
            border: 3px solid #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            font-size: 24px;
        }

        .title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .legend h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="title">RAG System Query Processing Flow</div>

    <div class="diagram-container">
        <div class="flow-diagram">
            <!-- SVG for arrows -->
            <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0; pointer-events: none;">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7"
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                    </marker>
                </defs>

                <!-- Flow arrows -->
                <path class="arrow" d="M 150 80 L 250 130" />
                <path class="arrow" d="M 350 150 L 450 150" />
                <path class="arrow" d="M 550 150 L 650 150" />
                <path class="arrow" d="M 750 150 L 850 150" />
                <path class="arrow" d="M 850 180 L 850 250" />
                <path class="arrow" d="M 830 280 L 730 280" />
                <path class="arrow" d="M 630 280 L 530 280" />
                <path class="arrow" d="M 530 250 L 530 180" />
                <path class="arrow" d="M 530 150 L 430 200" />
                <path class="arrow" d="M 430 240 L 530 290" />
                <path class="arrow" d="M 630 300 L 730 350" />
                <path class="arrow" d="M 730 380 L 630 380" />
                <path class="arrow" d="M 530 380 L 430 380" />
                <path class="arrow" d="M 330 380 L 230 330" />
                <path class="arrow" d="M 230 300 L 150 250" />
            </svg>

            <!-- User Icon -->
            <div class="user-icon">ðŸ‘¤</div>

            <!-- Components -->
            <div class="component frontend" style="top: 120px; left: 200px;">
                <div>Frontend</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    HTML/CSS/JS<br/>
                    Chat Interface<br/>
                    Session Management
                </div>
            </div>

            <div class="component api" style="top: 120px; left: 400px;">
                <div>FastAPI</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    /api/query endpoint<br/>
                    Request validation<br/>
                    Response formatting
                </div>
            </div>

            <div class="component rag" style="top: 120px; left: 600px;">
                <div>RAG System</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Query orchestration<br/>
                    Component coordination<br/>
                    Response assembly
                </div>
            </div>

            <div class="component ai" style="top: 120px; left: 800px;">
                <div>AI Generator</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Claude API calls<br/>
                    System prompts<br/>
                    Tool coordination
                </div>
            </div>

            <div class="component ai" style="top: 260px; left: 800px;">
                <div>Claude API</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Language model<br/>
                    Tool calling<br/>
                    Response generation
                </div>
            </div>

            <div class="component tools" style="top: 260px; left: 600px;">
                <div>Search Tools</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Course search tool<br/>
                    Tool management<br/>
                    Source tracking
                </div>
            </div>

            <div class="component data" style="top: 180px; left: 350px;">
                <div>Session Manager</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Conversation history<br/>
                    Context management<br/>
                    Memory limits
                </div>
            </div>

            <div class="component data" style="top: 330px; left: 600px;">
                <div>Vector Store</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    ChromaDB interface<br/>
                    Embedding search<br/>
                    Metadata filtering
                </div>
            </div>

            <div class="component data" style="top: 350px; left: 350px;">
                <div>Document Processor</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Text chunking<br/>
                    Course parsing<br/>
                    Content structuring
                </div>
            </div>

            <div class="component data" style="top: 350px; left: 150px;">
                <div>ChromaDB</div>
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
                    Vector database<br/>
                    Similarity search<br/>
                    Persistent storage
                </div>
            </div>

            <!-- Flow labels -->
            <div class="flow-label" style="top: 60px; left: 180px;">1. User query</div>
            <div class="flow-label" style="top: 140px; left: 320px;">2. HTTP POST</div>
            <div class="flow-label" style="top: 140px; left: 520px;">3. Process query</div>
            <div class="flow-label" style="top: 140px; left: 720px;">4. Generate response</div>
            <div class="flow-label" style="top: 200px; left: 860px;">5. Tool decision</div>
            <div class="flow-label" style="top: 270px; left: 760px;">6. Search execution</div>
            <div class="flow-label" style="top: 270px; left: 560px;">7. Vector search</div>
            <div class="flow-label" style="top: 190px; left: 460px;">8. Session update</div>
            <div class="flow-label" style="top: 360px; left: 660px;">9. Retrieve chunks</div>
            <div class="flow-label" style="top: 390px; left: 460px;">10. Document processing</div>
            <div class="flow-label" style="top: 280px; left: 160px;">11. Response display</div>

            <!-- Legend -->
            <div class="legend">
                <h3>Component Types</h3>
                <div class="legend-item">
                    <div class="legend-color frontend"></div>
                    Frontend Layer
                </div>
                <div class="legend-item">
                    <div class="legend-color api"></div>
                    API Layer
                </div>
                <div class="legend-item">
                    <div class="legend-color rag"></div>
                    RAG Orchestration
                </div>
                <div class="legend-item">
                    <div class="legend-color ai"></div>
                    AI Generation
                </div>
                <div class="legend-item">
                    <div class="legend-color tools"></div>
                    Search & Tools
                </div>
                <div class="legend-item">
                    <div class="legend-color data"></div>
                    Data Layer
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3>Query Processing Steps:</h3>
        <ol style="columns: 2; column-gap: 30px;">
            <li><strong>User Input:</strong> User types query in chat interface</li>
            <li><strong>HTTP Request:</strong> Frontend sends POST to /api/query</li>
            <li><strong>RAG Orchestration:</strong> Main system coordinates processing</li>
            <li><strong>AI Generation:</strong> Claude API called with tools available</li>
            <li><strong>Tool Decision:</strong> Claude decides whether to search or answer directly</li>
            <li><strong>Search Execution:</strong> If needed, search tool is executed</li>
            <li><strong>Vector Search:</strong> Semantic search through course materials</li>
            <li><strong>Session Update:</strong> Conversation history maintained</li>
            <li><strong>Content Retrieval:</strong> Relevant chunks retrieved from ChromaDB</li>
            <li><strong>Response Assembly:</strong> Final answer generated with sources</li>
            <li><strong>Frontend Display:</strong> Markdown rendered with collapsible sources</li>
        </ol>

        <h3>Key Features:</h3>
        <ul style="columns: 2; column-gap: 30px;">
            <li>Stateful conversations with session management</li>
            <li>Intelligent tool use based on query context</li>
            <li>Semantic search with vector embeddings</li>
            <li>Source attribution for transparency</li>
            <li>Real-time processing with loading indicators</li>
            <li>Structured course hierarchy preservation</li>
        </ul>
    </div>
</body>
</html>